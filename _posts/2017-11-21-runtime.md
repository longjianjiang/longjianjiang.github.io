---
layout: post
title:  "Runtime å­¦ä¹ ç¬”è®°"
date:   2017-11-21
excerpt: "æœ¬æ–‡ä¸»è¦ä»‹ç»äº†Runtimeä¸­çš„æ¶ˆæ¯æœºåˆ¶ã€‚"
tag:
- iOS
comments: true
---

> Runtimeåœ¨æˆ‘å¿ƒç›®ä¸­ä¸€ç›´æ˜¯ç¥ç§˜çš„ï¼Œæœ¬æ–‡æ˜¯å‰ä¸¤å¤©å¯¹Runtimeå­¦ä¹ çš„ä¸€ä¸ªæ€»ç»“ã€‚

# å‰è¨€
å› ä¸ºOCåœ¨ç¼–è¯‘å’Œé“¾æ¥æ—¶æ¨è¿Ÿäº†å¾ˆå¤šæ“ä½œï¼Œæ”¾åˆ°äº†è¿è¡Œæ—¶ã€‚è¿™å°±æ˜¯æ‰€è°“çš„åŠ¨æ€ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸ä»…ä»…éœ€è¦ç¼–è¯‘å™¨ï¼Œè€Œä¸”ä¹Ÿéœ€è¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿå»æ‰§è¡Œè¿™äº›ç¼–è¯‘åçš„ä»£ç ã€‚

å…¶å®Runtimeçœ‹ä¼¼ç¥ç§˜ï¼Œå…¶å®æˆ‘ä»¬æ¯å¤©éƒ½åœ¨å’Œä»–æ‰“äº¤é“ã€‚å½“æˆ‘ä»¬æ­£å¸¸ç¼–å†™OCä»£ç ç¼–è¯‘çš„æ—¶å€™ï¼ŒRuntimeå°±ä¼šè‡ªåŠ¨çš„ä¸ºæˆ‘ä»¬åšä¸€äº›äº‹æƒ…, æ¯”å¦‚å¼€å¯ARCååœ¨è¿è¡Œæ—¶Runtimeä¼šè‡ªåŠ¨çš„æ·»åŠ `objc_retain`, `objc_release `, `objc_autorelease`ç­‰å†…å­˜ç®¡ç†æ–¹æ³•ï¼›
å½“æˆ‘ä»¬ä½¿ç”¨åˆ°`isKindOfClass:`, `respondsToSelector:`,`conformsToProtocol:`, `load`ç­‰ä¸€äº›`NSObject`åè®®ä¸­æˆ–è€…ç±»ä¸­æ–¹æ³•æ—¶ï¼Œå…¶å®ä¹Ÿæ˜¯å’ŒRuntimeè¿›è¡Œäº¤äº’äº†ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•éƒ½æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œå‘Runtimeå»è¯¢é—®ä¿¡æ¯çš„ï¼›

#  Non-fragile ivars
Runtimeåˆ†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œ`modern` å’Œ `legacy`,iOSå¼€å‘çš„æ—¶å€™å°±æ˜¯`modern`äº†ã€‚
`modern` å’Œ `legacy`ä¸¤ä¸ªç‰ˆæœ¬çš„ä¸»è¦åŒºåˆ«å°±æ˜¯ï¼Œ`modern`æ”¯æŒäº†Non-fragile ivarsç‰¹æ€§ã€‚
Non-fragile ivarså°±æ˜¯å½“æ”¹å˜ç±»çš„æˆå‘˜å˜é‡ç»“æ„åï¼Œæœ¬ç±»çš„å­ç±»çš„å¯¹è±¡ä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œè¿˜å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯åœ¨`legacy`æ—¶ï¼Œå°±å¿…é¡»é‡æ–°ç¼–è¯‘äº†ã€‚

 ä¸€èˆ¬å½“iOSç³»ç»Ÿæ›´æ–°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šåœ¨åŸºç±»ä¸­å¢åŠ ä¸€äº›æ–°çš„æˆå‘˜å˜é‡ï¼Œæ­¤æ—¶åŸæœ¬å·¥ç¨‹ä¸­çš„å­ç±»çš„ç»“æ„å› ä¸ºåœ¨ç¼–è¯‘çš„æ—¶å€™å·²ç»ç¡®å®šï¼Œäºæ˜¯å°±å’Œæ–°ç‰ˆæœ¬çš„åŸºç±»ç»“æ„äº§ç”Ÿå†²çªï¼Œæ‰€ä»¥å¿…é¡»è¦é‡æ–°ç¼–è¯‘ï¼›è€Œä¸”å¦‚æœè¿™äº›å­ç±»æ˜¯ä¸€ä¸ªå·¥ç¨‹ä¸­çš„æŸä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åªèƒ½ç­‰ä½œè€…æ›´æ–°,æ‰€ä»¥è¿™ç§ç—›è‹¦æˆ‘ä»¬iOSå¼€å‘è€…æ˜¯ä½“ä¼šä¸åˆ°çš„ğŸ˜‚ã€‚

è€Œ`modern` çš„Runtimeå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“iOSç³»ç»Ÿæ›´æ–°æ—¶ï¼Œåœ¨åŸºç±»ä¸­å¢åŠ ä¸€äº›æ–°çš„æˆå‘˜å˜é‡åï¼Œåœ¨è¿è¡Œæ—¶ï¼ŒRuntimeä¼šåŠ¨æ€è°ƒæ•´å­ç±»çš„ç»“æ„ï¼Œä»è€Œä¸ä¼šäº§ç”Ÿé‡å ï¼Œäºæ˜¯ä¸ç”¨é‡æ–°ç¼–è¯‘å°±å¯ä»¥è¿è¡Œäº†ã€‚æ­¤æ—¶OCçš„åº“ä»æ­¤å…·æœ‰äº†`äºŒè¿›åˆ¶å…¼å®¹æ€§`ï¼Œå½“iOSç‰ˆæœ¬ä¸æ–­æ›´æ–°ï¼Œè¿™ä¸ªiOSåº“è¿˜æ˜¯å¯ä»¥æ­£å¸¸è¢«ä½¿ç”¨ã€‚

# æ¶ˆæ¯æœºåˆ¶
> OCå…¶å®æ˜¯å°è£…äº†Cè¯­è¨€ï¼Œä½¿å…¶å…·æœ‰é¢å‘å¯¹è±¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶å‚è€ƒäº†`Smalltalk`çš„æ¶ˆæ¯æœºåˆ¶ã€‚

## objc_msgSend
OCä¸­æˆ‘ä»¬è°ƒç”¨æ–¹æ³•ä¸€èˆ¬ä½¿ç”¨ä¸­æ‰©å·è¯­æ³•ï¼Œå¦‚ä¸‹ï¼š

{% highlight objective_c %}
[longjianjiang eat:@"apple"]
{% endhighlight %}

å½“è¿è¡Œæ—¶ï¼Œæ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«Runtimeè½¬æ¢ä¸ºå‘é€æ¶ˆæ¯çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡`objc_msgSend`å‡½æ•°å»å®ç°ã€‚æ‰€ä»¥ä¸Šè¿°çš„æ–¹æ³•è°ƒç”¨å°±ä¼šè¢«è½¬åŒ–ä¸ºä¸‹é¢çš„å‡½æ•°è°ƒç”¨(æˆ‘ä»¬ç›´æ¥è¿™æ ·å†™ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨è¿›è¡Œè½¬åŒ–çš„)ï¼š

{% highlight cpp %}
objc_msgSend(longjianjiang, @selector(eat), @"apple")
{% endhighlight %}

### æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹

>æ ¹æ®selectorå¯»æ‰¾å¯¹åº”çš„IMP

#### 1.é¦–å…ˆå»`methodLists`ä¸­å»å¯»æ‰¾;

è¿™é‡Œå¾—äº†è§£ä¸‹OCä¸­å¯¹è±¡å’Œç±»çš„å¤§è‡´ç»“æ„(ä»¥ä¸‹ä»£ç æ‘˜è‡ªobjc4-709)ï¼š

{% highlight cpp %}
struct objc_object {
private:
    isa_t isa;
};
{% endhighlight %}

{% highlight cpp %}
struct objc_class : objc_object {
    Class superclass;
    const char *name;
    uint32_t version;
    uint32_t info;
    uint32_t instance_size;
    struct old_ivar_list *ivars;
    struct old_method_list **methodLists;
    Cache cache;
    struct old_protocol_list *protocols;
    // CLS_EXT only
    const uint8_t *ivar_layout;
};
{% endhighlight %}

{% highlight cpp %}
struct old_method {
    SEL method_name;
    char *method_types;
    IMP method_imp;
};

struct old_method_list {
    void *obsolete;

    int method_count;
#ifdef __LP64__
    int space;
#endif
    /* variable length structure */
    struct old_method method_list[1];
};
{% endhighlight %}

çœ‹äº†ä¸Šè¿°çš„ç»“æ„ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥çŒœæƒ³åˆ°å¯»æ‰¾çš„è¿‡ç¨‹åº”è¯¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š


![å±å¹•å¿«ç…§ 2017-07-12 11.22.42.png]({{site.url}}/assets/images/blog/runtime_1.png)

>æˆ‘ä»¬æ³¨æ„åˆ°ç±»çš„ç»“æ„ä½“ä¸­æœ‰ä¸ª`cache`,æ˜¯ä¹‹å‰è¢«è°ƒç”¨è¿‡çš„æ–¹æ³•ã€‚æ‰€ä»¥åœ¨`methodLists`ä¸­å¯»æ‰¾ä¹‹å‰ï¼ŒRuntimeä¼šåœ¨`cahce`ä¸­å¯»æ‰¾ã€‚è¿™æ ·å¯ä»¥åŠ é€Ÿæ‰§è¡Œé€Ÿåº¦ã€‚

#### 2.åŠ¨æ€å¢åŠ å®ç°

å¦‚æœç¬¬ä¸€æ­¥ä¸­æ²¡æœ‰æ‰¾åˆ°selectorå¯¹åº”çš„IMPæ€ä¹ˆåŠå‘¢ï¼Ÿ

æ­¤æ—¶Runtimeä¼šåœ¨ç±»ä¸­å¯»æ‰¾æ˜¯å¦æœ‰å®ç°`resolveInstanceMethod:`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥åŠ¨æ€çš„ä¸ºç±»çš„å®ä¾‹æ–¹æ³•å¢åŠ ä¸€ä¸ªå®ç°ï¼Œå¯¹åº”çš„`resolveClassMethod:`å¯ä»¥åŠ¨æ€çš„ä¸ºç±»çš„ç±»æ–¹æ³•å¢åŠ ä¸€ä¸ªå®ç°ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºPersonç±»ä¸­ä¸ºeatæ–¹æ³•åŠ¨æ€å¢åŠ äº†å®ç°ï¼š

{% highlight objective_c %}
void dynamicMethodIMP(id obj, SEL _cmd) {
    NSLog(@"%@",NSStringFromClass([obj class]));
    [obj writeSomeThing:@"JJJJJJJJJ"];
    NSLog(@"eat delicious food");
}


+ (BOOL)resolveInstanceMethod:(SEL)sel {
    if (sel == @selector(eat)) {
        IMP eatIMP = imp_implementationWithBlock(^(id obj) {
            Person* p = (Person*)obj;
            NSLog(@"%@",NSStringFromClass([obj class]));
            NSLog(@"eat delicious food");
            [p writeSomeThing:@"test"];
        });
        
        class_addMethod([self class], sel, (IMP)dynamicMethodIMP , "v@:");
        return YES;
    }
    return [super resolveInstanceMethod:sel];
}
{% endhighlight %}

>ä¸Šè¿°ä»£ç é€šè¿‡`class_addMethod`æ–¹æ³•ç»™ç±»å¢åŠ äº†ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶å®OCä¸­çš„æ–¹æ³•å’Œæ™®é€šçš„Cè¯­è¨€å‡½æ•°æ²¡ä»€ä¹ˆä¸åŒå°±æ˜¯å¢åŠ äº†ä¸¤ä¸ªå‚æ•°ï¼šselfå’Œ_cmd ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ–¹æ³•è€…å’Œæ–¹æ³•çš„selectorã€‚

#### 3.æ¶ˆæ¯è½¬å‘

å¦‚æœç»è¿‡å‰é¢ä¸¤æ­¥ï¼Œä¾ç„¶æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„IMPï¼Œæ­¤æ—¶Runtimeä¼šå†ç»™æœ€åä¸€æ¬¡æœºä¼šï¼Œå¦‚ä¸‹ä»£ç Personç±»å®ç°äº†singæ¶ˆæ¯çš„è½¬å‘ï¼š

{% highlight objective_c %}
// 2. æ£€æµ‹ç”Ÿæˆçš„æ–¹æ³•ç­¾åçš„å‚æ•°å’Œè¿”å›å€¼æ˜¯å¦å’Œselectorçš„ä¸€è‡´
// ç„¶åå»forwardInvocation:æ–¹æ³•
-(NSMethodSignature*)methodSignatureForSelector:(SEL)selector {
    NSMethodSignature *signature = [super methodSignatureForSelector:selector];
    if (! signature) {
        //ç”Ÿæˆæ–¹æ³•ç­¾å
        signature = [singer methodSignatureForSelector:selector];
    }
    return signature;
}

// 3. æ ¹æ®invocationä¸­åŒ…å«çš„ä¿¡æ¯è°ƒç”¨invokeWithTarget:æ–¹æ³•
- (void)forwardInvocation:(NSInvocation *)anInvocation {
    SEL aSelector = [anInvocation selector];
    
    if (aSelector == @selector(sing)) {
        if ([singer respondsToSelector:aSelector])
            [anInvocation invokeWithTarget:singer];
        else
            [super forwardInvocation:anInvocation];
    }
}

// 1. é¦–å…ˆåˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦å®ç°ï¼Œå¦‚æœå®ç°ç›´æ¥å»è¿”å›çš„å¯¹è±¡ä¸­å¯»æ‰¾selectorçš„IMPï¼Œ
// å¦åˆ™å»methodSignatureForSelector:æ–¹æ³•
- (id)forwardingTargetForSelector:(SEL)aSelector {
    return singer;
}
{% endhighlight %}

å¦‚æœè½¬å‘å¤±è´¥ï¼Œåˆ™ä¼šå»è°ƒç”¨`doesNotRecognizeSelector`æ–¹æ³•ï¼Œè¿™æ—¶å€™å°±ä¼šå‡ºç°ä¸€ä¸ªæˆ‘ä»¬ç†Ÿæ‚‰çš„é”™è¯¯ï¼š

> æ­¤æ—¶çš„`doesNotRecognizeSelector`å…¶å®æ˜¯è°ƒç”¨çš„NSObjectçš„`forwardInvocation:` ä¸­çš„å®ç°;

```
-[Person sing]: unrecognized selector sent to instance 0x10046cde0
```

# æœ€å

æœªå®Œå¾…ç»­ã€‚
