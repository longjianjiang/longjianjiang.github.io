---
layout: post
title:  "HTTP学习笔记"
date:   2019-01-24
excerpt:  "本文是笔者学习HTTP的笔记"
tag:
- Networking
comments: true
---

# TLS/SSL

TLS(Transport Layer Security)是一个安全协议，前身是SSL(Secure Sockets Layer)，https(http over tls)就是通过TLS来对传输内容进行加密的,下面笔者使用 `Wireshark` 观察TLS握手的过程，完整过程如图所示:

![http_note_1]({{site.url}}/assets/images/blog/http_note_1.png)

> 可以看到在进行TLS握手之前，前面是TCP的三次握手;

- Client Hello

这一步客户端会发送自己运行的TLS版本(Version)，支持的加密方式(Cipher Suites)，同时会生成一个随机数(Random)记做 `client random`，抓包如下所示:

![http_note_2]({{site.url}}/assets/images/blog/http_note_2.png)

- 1.Server Hello + 2.Certificate + 3.Server Key Exchange + 4.Server Hello Done

1.服务端收到消息后，会确认一个加密方式(Cipher Suites)，生成一个随机数(Random)记做 `server random`。

2.因为如果直接发送公钥会被篡改，所以服务端需要去CA对公钥做认证，CA用自己的私钥对服务端的公钥等其他信息进行加密，生成一份数字证书，将该证书给客户端(Certificate)。

3.这一步使用了[DH(Diffie-Hellman)算法](http://wsfdl.com/algorithm/2016/02/04/%E7%90%86%E8%A7%A3Diffie-Hellman%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2%E7%AE%97%E6%B3%95.html)实现第三个随机数记做`premaster secret`的传递，因为整个握手的阶段都是明文传递，如果有人监听是可以知道双方协定的加密算法和前面两个随机数(`client random`,`server random`)，所以第三个随机数则一定要保证安全。

使用DH的算法的好处是，双方不直接明文的传递第三个随机数，而是相互传递DH算法的参数，然后双方就可以算出唯一的`premaster secret`。

> 如果不使用DH算法，则客户端验证服务端证书有效后，取出证书中的公钥，生成第三个随机数，用公钥加密，传递给服务端。服务端使用自己的私钥获取客户端发送过来的第三个随机数。

这一步服务端向客户端传递了DH算法的 server params。

4.服务端通知客户端Server Hello过程结束。

整个过程抓包如下所示:

![http_note_3]({{site.url}}/assets/images/blog/http_note_3.png)

- 1.Client Key Exchange + 2.Change Cipher Spec + 3.Encrypted Handshake Message

1.这一步则是客户端向服务端传递DH算法的 client params，此时双方都有了三个随机数(`client random`,`server random`,`premaster secret`)，此时双方会用之前协定好的一个加密算法生成一份对话密钥(`session key`)，使用协定好的加密算法加密接下来的整个会话过程。

2.这一步是一个事件消息，通知服务端接下来的会话传递都是用`session key`进行加密了。

3.这里客户端发送了一条用`session key`加密的消息给服务端，也是客户端的Finish消息，如果服务端可以解密，证明双方的`session key`是一致的。

整个过程抓包如下所示:

![http_note_4]({{site.url}}/assets/images/blog/http_note_4.png)

- 1.Change Cipher Spec + 2.Encrypted Handshake Message

1.这一步是一个事件消息，通知客户端接下来的会话传递都是用`session key`进行加密了。

2.这里服务端发送了一条用`session key`加密的消息给客户端，也是服务端的Finish消息，如果客户端可以解密，证明双方的`session key`是一致的。

整个过程抓包如下所示:

![http_note_5]({{site.url}}/assets/images/blog/http_note_5.png)

至此，TLS的握手过程到此结束，整个过程如下所示:

![http_note_6]({{site.url}}/assets/images/blog/http_note_6.png)

- Application Data

此后，接下来的数据传输都是使用`session key`进行加密，抓包如下所示:

![http_note_7]({{site.url}}/assets/images/blog/http_note_7.png)

> 可以看到TLS的握手阶段使用的是非对称加密，后面的会话过程则使用的是对称加密。