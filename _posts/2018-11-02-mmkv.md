---
layout: post
title:  "MMKV阅读笔记"
date:   2018-11-02
excerpt:  "本文是笔者阅读MMKV的笔记"
tag:
- iOS
comments: true
---

MMKV是一个key-value存储的库，下面笔者来分析下它的源代码。

## 内存相关函数

MMKV中使用了一些c语言提供的内存相关的函数，下面先列举出来：

`void	*memcpy(void *__dst, const void *__src, size_t __n);`
将src地址开始的连续n个字节数据复制到以dst地址开始的空间内。

`void	*memset(void *__b, int __c, size_t __len);`
将b地址开始的前len个字节全部设置为c。当b指向一段字符时，c也可以为char类型，实际设置的则是该字符对应的ASCII码值。

```
  vector<int16_t> arr(5, 9);
    
    for (int i = 0; i < 5; ++i) {
        printf("%d\n",(arr)[i]);
    }
    
    
    memset(&arr[0], 1, sizeof(int) * 5);
    
    for (int i = 0; i < 5; ++i) {
        printf("%d\n",(arr)[i]);
    }
    
    printf("%d",0x0100);
```

`void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offsize);`
将open函数返回的file descriptor中长为length的部分对应到以start地址（设置为nullptr系统会自动分配，然后返回）开始的内存区域中。实现操作内存映射到文件中，也就是对内存的读写也就是对文件的读写。offsize表示文件偏移量，一般设置位0表示从文件最开始部分开始映射。此时需要将flags设置为`MAP_SHARED`。

prot有下面的几种选择：

```
/*
 * Protections are chosen from these bits, or-ed together
 */
#define	PROT_NONE	0x00	/* [MC2] no permissions */
#define	PROT_READ	0x01	/* [MC2] pages can be read */
#define	PROT_WRITE	0x02	/* [MC2] pages can be written */
#define	PROT_EXEC	0x04	/* [MC2] pages can be executed */
```