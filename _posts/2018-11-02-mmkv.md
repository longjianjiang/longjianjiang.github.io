---
layout: post
title:  "MMKV阅读笔记"
date:   2018-11-02
excerpt:  "本文是笔者阅读MMKV的笔记"
tag:
- iOS
comments: true
---

MMKV是一个key-value存储的库，下面笔者来分析下它的源代码。

# C函数

> MMKV中使用了一些C语言提供的内存和文件相关的函数，下面先列举出来：

## 文件相关函数

`int open(const char *, int, ...);`
将给定的文件路径以指定flags和指定mode打开，返回file descriptor。具体flags和mode的取值可以参看头文件注释。

`int ftruncate(int fd, off_t length);`
将open函数返回的file descriptor中指向的文件大小改为length指定的大小。如果原来文件大小大于length的话，则超过部分会被丢弃。

`int fstat(int, struct stat *buf);`
给定open函数返回的file descriptor，返回该文件描述符指向的文件的文件信息，将其存储在buf指针指向的结构体中。

`int stat(const char *file_name, struct stat *buf);`
给定文件名，返回该文件对应的文件信息，将其存储在buf指针指向的结构体中。

`int lstat(const char *file_name, struct stat *buf);`
和stat函数功能一样，只是当文件是符号链接时，lstat返回的是该符号链接的信息。

## 内存相关函数

`void *memcpy(void *__dst, const void *__src, size_t __n);`
将src地址开始的连续n个字节数据复制到以dst地址开始的空间内。

`void *memset(void *__b, int __c, size_t __len);`
将b地址开始的前len个字节全部设置为c。当b指向一段字符时，c也可以为char类型，实际设置的则是该字符对应的ASCII码值。

`void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offsize);`
将open函数返回的file descriptor中长为length的部分对应到以start地址（设置为nullptr系统会自动分配，然后返回）开始的内存区域中。实现操作内存映射到文件中，也就是对内存的读写也就是对文件的读写。offsize表示文件偏移量，一般设置位0表示从文件最开始部分开始映射。此时需要将flags设置为`MAP_SHARED`。

`int mlock(const void *addr, size_t len);`
将内存指定大小加锁

`int munlock(const void *addr, size_t len);`
将内存指定大小解锁

# Protocol Buffer

> MMKV使用PB来进行数据的序列化存储

PB是Google开源的一种通信协议，和XML的功能是类似的，PB使用`varint`来压缩数据，这样节约了存储空间，提高了传输速度。

## varint

- 使用最少的字节来保存一个数字，比如一个int32_t的value存1，原本需要4个字节，而实际这个数字只占用了一个字节，所以使用该种方式只需要占用一个字节就可以保存改数字了。

- 这种方式的每个字节的第一位有特殊含义，如果该位为1说明后续的字节是该数字的一部分；如果该位为0，说明此时的字节就是该数字的最后一个字节。

> 而且PB使用了小端的方式来存储，也就是第一个字节存储了数字的最低位。 大端则第一个字节存储了最高位。

举个例子，在PB的varint下，150二进制存储为`9601`，变换如下所示:

```
96 01 = 1001 0110  0000 0001
       → 000 0001  ++  001 0110 (去掉首位标志位，倒置字节顺序)
       → 10010110
       → 128 + 16 + 4 + 2 = 150
```

# MiniCodedInputData & MiniCodedOutputData

前面说到MMKV使用PB进行数据序列化，实际工程中使用上述两个类进行二进制编码和解码。

## MiniCodedOutputData

## MiniCodedInputData


# 接口

MMKV提供了一系列的set&get的方法，类似`NSUserDefaults`。

```
MMKV *mmkv = [MMKV defaultMMKV];
    
[mmkv setBool:YES forKey:@"bool"];
BOOL bValue = [mmkv getBoolForKey:@"bool"];
    
[mmkv setInt32:-1024 forKey:@"int32"];
int32_t iValue = [mmkv getInt32ForKey:@"int32"];
    
[mmkv setObject:@"hello, mmkv" forKey:@"string"];
NSString *str = [mmkv getObjectOfClass:NSString.class forKey:@"string"];
```

以上代码从MMKV Demo中摘录，我们可以发现使用起来和`NSUserDefaults`十分类似。

## set
MMKV提供给我们的各种类型的set方法，其实内部都是通过将不同类型的数据先转成二进制形式，然后内部再调用`setData:forKey:`完成存储。

